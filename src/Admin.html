<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LeaderTV – Админ</title>

  <!-- Същите стилове като на index.html -->
  <style>
  :root{
    --bg:#f8fafc;--panel:#fff;--fg:#0f172a;--muted:#64748b;--border:#e5e7eb;
    --ring:#2563eb;--shadow:0 8px 24px rgba(2,6,23,.06);
    --green:#16a34a;--green-600:#15803d;--red:#ef4444;--red-600:#dc2626;--amber:#f59e0b;--amber-600:#d97706;
    --gray-100:#f3f4f6;--gray-200:#e5e7eb;
  }
  *{box-sizing:border-box}html,body{height:100%}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;margin:0;color:var(--fg);background:var(--bg)}
  header{position:sticky;top:0;z-index:20;background:var(--panel);border-bottom:1px solid var(--border);backdrop-filter:saturate(160%) blur(6px)}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  nav a{display:inline-block;margin-right:14px;color:var(--fg);text-decoration:none;padding:8px 10px;border-radius:10px;transition:.15s}
  nav a:hover{background:var(--gray-100)} nav a u{text-underline-offset:3px}
  h1{font-size:28px;margin:22px 0}h2{font-size:20px;margin:14px 0}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:22px}
  @media (max-width:900px){.grid,.row{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
  .item{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 4px 14px rgba(2,6,23,.05)}
  .muted{color:var(--muted)} .meta{font-size:.92rem;color:var(--muted)}
  input[type=text], input[type=date], input[type=password], textarea{
    width:100%;background:#fff;color:var(--fg);border:1px solid var(--border);
    border-radius:10px;padding:10px 12px;transition:border-color .15s,box-shadow .15s;
  }
  textarea{min-height:130px;resize:vertical}
  input:focus, textarea:focus{outline:0;border-color:var(--ring);box-shadow:0 0 0 3px rgba(37,99,235,.18)}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;border:0;border-radius:10px;padding:10px 14px;font-weight:600;transition:transform .08s, box-shadow .15s, background .15s}
  .btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn-primary{background:var(--green);color:#fff;box-shadow:0 6px 18px rgba(22,163,74,.25)}
  .btn-primary:hover{background:var(--green-600)}
  .btn-secondary{background:var(--gray-100)}
  .btn-secondary:hover{background:var(--gray-200)}
  .btn-danger{background:var(--red);color:#fff;box-shadow:0 6px 18px rgba(239,68,68,.22)}
  .btn-danger:hover{background:var(--red-600)}
  .btn-warning{background:var(--amber);color:#fff;box-shadow:0 6px 18px rgba(245,158,11,.22)}
  .btn-warning:hover{background:var(--amber-600)}
  .status{display:flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:999px;background:var(--green);box-shadow:0 0 0 0 rgba(34,197,94,.6);animation:pulse 1.6s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,.55)}70%{box-shadow:0 0 0 10px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
  footer{border-top:1px solid var(--border);margin-top:40px}
  .api-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .pwd-row{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;gap:16px;justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:12px">
        <img src="/favicon.ico" alt="" width="20" height="20" />
        <strong>LeaderTV</strong>
      </div>
      <nav>
        <a href="/">Начало</a>
        <a href="/#news">Новини</a>
        <a href="/#events">Събития</a>
        <a href="/admin"><u>Админ</u></a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1>Админ панел</h1>

    <!-- Вход / статус -->
    <div class="card" style="margin-bottom:18px">
      <div class="row" style="align-items:end">
        <div>
          <label class="muted">Админ ключ:</label>
          <div class="pwd-row">
            <input id="key" type="password" placeholder="въведи парола…" />
            <button class="btn btn-secondary" id="togglePwd" type="button" aria-label="Покажи/скрий">Покажи</button>
            <button class="btn btn-primary" id="loginBtn" type="button">Вход</button>
            <button class="btn btn-secondary" id="logoutBtn" type="button">Изход</button>
          </div>
        </div>
        <div>
          <div class="api-row">
            <span class="muted">API:</span>
            <a id="apiLink" href="#" target="_blank" rel="noopener noreferrer"></a>
            <span class="status" id="loginState"><span class="dot"></span><span>Влязъл</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Публикуване -->
    <section class="grid">
      <div class="card">
        <h2>Публикувай новина</h2>
        <label class="muted">Заглавие</label>
        <input id="nTitle" type="text" placeholder="Заглавие" />
        <div class="row" style="margin-top:10px">
          <div>
            <label class="muted">Дата (YYYY-MM-DD)</label>
            <input id="nDate" type="text" placeholder="YYYY-MM-DD" />
          </div>
        </div>
        <div style="margin-top:10px">
          <label class="muted">Текст</label>
          <textarea id="nBody" placeholder="Текст на новината…"></textarea>
        </div>
        <div style="margin-top:12px">
          <button id="publishNews" class="btn btn-primary">Публикувай</button>
        </div>

        <h2 style="margin-top:22px">Последни новини</h2>
        <div id="newsList" style="display:grid;gap:12px"></div>
        <p id="newsEmpty" class="muted" style="display:none">Няма записи.</p>
      </div>

      <div class="card">
        <h2>Публикувай събитие</h2>
        <label class="muted">Заглавие</label>
        <input id="eTitle" type="text" placeholder="Заглавие" />
        <div class="row" style="margin-top:10px">
          <div>
            <label class="muted">Дата</label>
            <input id="eDate" type="text" placeholder="YYYY-MM-DD" />
          </div>
          <div>
            <label class="muted">Локация</label>
            <input id="eLocation" type="text" placeholder="Град/онлайн…" />
          </div>
        </div>
        <div style="margin-top:12px">
          <button id="publishEvent" class="btn btn-primary">Публикувай</button>
        </div>

        <h2 style="margin-top:22px">Предстоящи събития</h2>
        <div id="eventsList" style="display:grid;gap:12px"></div>
        <p id="eventsEmpty" class="muted" style="display:none">Няма записи.</p>
      </div>
    </section>
  </main>

  <footer class="wrap">
    <p class="muted">© 2025 LeaderTV. Всички права запазени.</p>
  </footer>

  <!-- ===== JS ===== -->
  <script type="module">
    // API base от Vercel/Vite env
    const API_URL   = (import.meta?.env?.VITE_API_URL   ?? '').replace(/\/$/,'');
    const API_PREF  =  import.meta?.env?.VITE_API_PREFIX ?? '/api';
    const API_BASE  = (API_URL || '') + API_PREF;

    // DOM
    const keyInput = document.getElementById('key');
    const togglePwd = document.getElementById('togglePwd');
    const loginBtn  = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const apiLink   = document.getElementById('apiLink');
    const loginState= document.getElementById('loginState');

    const nTitle = document.getElementById('nTitle');
    const nDate  = document.getElementById('nDate');
    const nBody  = document.getElementById('nBody');
    const publishNews = document.getElementById('publishNews');
    const newsList = document.getElementById('newsList');
    const newsEmpty = document.getElementById('newsEmpty');

    const eTitle = document.getElementById('eTitle');
    const eDate  = document.getElementById('eDate');
    const eLocation = document.getElementById('eLocation');
    const publishEvent = document.getElementById('publishEvent');
    const eventsList = document.getElementById('eventsList');
    const eventsEmpty= document.getElementById('eventsEmpty');

    // Init UI
    apiLink.textContent = API_BASE;
    apiLink.href = API_BASE;

    // Admin key в локално хранилище
    const LS_KEY = 'leader_admin_key';
    function getKey(){ return localStorage.getItem(LS_KEY) || ''; }
    function setKey(v){ localStorage.setItem(LS_KEY, v || ''); }
    function clearKey(){ localStorage.removeItem(LS_KEY); }

    // Показване/скриване на парола
    togglePwd.addEventListener('click', ()=>{
      if(keyInput.type === 'password'){ keyInput.type = 'text'; togglePwd.textContent = 'Скрий'; }
      else { keyInput.type = 'password'; togglePwd.textContent = 'Покажи'; }
    });

    // Логика на вход/изход
    function reflectLogin(){
      const have = !!getKey();
      loginState.style.opacity = have ? '1' : '.4';
      loginBtn.disabled = have;
      logoutBtn.disabled = !have;
    }
    loginBtn.addEventListener('click', async ()=>{
      const k = keyInput.value.trim();
      if(!k){ alert('Въведи админ ключ.'); return; }
      setKey(k);
      reflectLogin();
      alert('Влязъл.');
    });
    logoutBtn.addEventListener('click', ()=>{
      clearKey();
      reflectLogin();
      alert('Излязъл.');
    });

    // Помощни
    function escapeHTML(s=''){return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
    function escapeMultiline(s=''){return escapeHTML(s).replace(/\n/g,'<br/>')}

    async function getJSON(path){
      const r = await fetch(API_BASE + path, {headers:{'accept':'application/json'}});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }
    async function sendJSON(method, path, body){
      const r = await fetch(API_BASE + path, {
        method,
        headers:{
          'content-type':'application/json',
          'x-admin-key': getKey() || ''
        },
        body: body ? JSON.stringify(body) : undefined
      });
      if(!r.ok){
        const t = await r.text().catch(()=> '');
        throw new Error('HTTP '+r.status+' '+t);
      }
      return r.json().catch(()=> ({}));
    }

    // Рендер елемент за новина + действия
    function newsItem(n){
      const box = document.createElement('article'); box.className='item';
      box.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:baseline">
          <strong>${escapeHTML(n.title)}</strong>
          <span class="meta">${escapeHTML(n.date || '')}</span>
        </div>
        ${n.body ? `<div style="margin-top:6px">${escapeMultiline(n.body)}</div>` : ''}
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn btn-warning">Редакция</button>
          <button class="btn btn-danger">Изтриване</button>
        </div>
      `;
      const [editBtn, delBtn] = box.querySelectorAll('button');

      // Редакция (inline)
      editBtn.addEventListener('click', ()=>{
        const form = document.createElement('div');
        form.className='item';
        form.style.marginTop='10px';
        form.innerHTML = `
          <label class="muted">Заглавие</label>
          <input type="text" value="${escapeHTML(n.title)}" />
          <div class="row" style="margin-top:10px">
            <div><label class="muted">Дата</label><input type="text" value="${escapeHTML(n.date || '')}" /></div>
          </div>
          <div style="margin-top:10px">
            <label class="muted">Текст</label>
            <textarea>${escapeHTML(n.body || '')}</textarea>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn btn-primary">Запази</button>
            <button class="btn btn-secondary">Отказ</button>
          </div>
        `;
        box.appendChild(form);
        const [ti, da, ta] = form.querySelectorAll('input,textarea');
        const [save, cancel] = form.querySelectorAll('button');

        save.addEventListener('click', async ()=>{
          try{
            await sendJSON('PUT', `/news/${encodeURIComponent(n.id)}`, {
              title: ti.value.trim(),
              date:  da.value.trim(),
              body:  ta.value.trim()
            });
            alert('Промените са записани.');
            await reloadLists();
          }catch(e){ alert('Грешка: '+e.message); }
        });
        cancel.addEventListener('click', ()=> form.remove());
      });

      // Изтриване
      delBtn.addEventListener('click', async ()=>{
        if(!confirm('Сигурни ли сте, че искате да изтриете тази новина?')) return;
        try{
          await sendJSON('DELETE', `/news/${encodeURIComponent(n.id)}`);
          await reloadLists();
        }catch(e){ alert('Грешка: '+e.message); }
      });

      return box;
    }

    function eventItem(ev){
      const box = document.createElement('article'); box.className='item';
      box.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:baseline">
          <strong>${escapeHTML(ev.title)}</strong>
          <span class="meta">${escapeHTML(ev.date || '')}</span>
        </div>
        ${ev.location ? `<div class="meta" style="margin-top:6px">Локация: ${escapeHTML(ev.location)}</div>` : ''}
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn btn-warning">Редакция</button>
          <button class="btn btn-danger">Изтриване</button>
        </div>
      `;
      const [editBtn, delBtn] = box.querySelectorAll('button');

      editBtn.addEventListener('click', ()=>{
        const form = document.createElement('div');
        form.className='item';
        form.style.marginTop='10px';
        form.innerHTML = `
          <label class="muted">Заглавие</label>
          <input type="text" value="${escapeHTML(ev.title)}" />
          <div class="row" style="margin-top:10px">
            <div><label class="muted">Дата</label><input type="text" value="${escapeHTML(ev.date || '')}" /></div>
            <div><label class="muted">Локация</label><input type="text" value="${escapeHTML(ev.location || '')}" /></div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn btn-primary">Запази</button>
            <button class="btn btn-secondary">Отказ</button>
          </div>
        `;
        box.appendChild(form);
        const [ti, da, lo] = form.querySelectorAll('input');
        const [save, cancel] = form.querySelectorAll('button');

        save.addEventListener('click', async ()=>{
          try{
            await sendJSON('PUT', `/events/${encodeURIComponent(ev.id)}`, {
              title: ti.value.trim(),
              date:  da.value.trim(),
              location: lo.value.trim()
            });
            alert('Промените са записани.');
            await reloadLists();
          }catch(e){ alert('Грешка: '+e.message); }
        });
        cancel.addEventListener('click', ()=> form.remove());
      });

      delBtn.addEventListener('click', async ()=>{
        if(!confirm('Сигурни ли сте, че искате да изтриете това събитие?')) return;
        try{
          await sendJSON('DELETE', `/events/${encodeURIComponent(ev.id)}`);
          await reloadLists();
        }catch(e){ alert('Грешка: '+e.message); }
      });

      return box;
    }

    // Зареждане на списъците
    async function reloadLists(){
      try{
        const [news, evs] = await Promise.all([ getJSON('/news'), getJSON('/events') ]);
        newsList.innerHTML = '';
        if(!news.length){ newsEmpty.style.display='block'; } else {
          newsEmpty.style.display='none';
          news.forEach(n => newsList.appendChild(newsItem(n)));
        }
        eventsList.innerHTML = '';
        if(!evs.length){ eventsEmpty.style.display='block'; } else {
          eventsEmpty.style.display='none';
          evs.forEach(e => eventsList.appendChild(eventItem(e)));
        }
      }catch(e){
        console.error(e);
        newsEmpty.style.display='block'; eventsEmpty.style.display='block';
      }
    }

    // Публикуване
    publishNews.addEventListener('click', async ()=>{
      if(!getKey()){ alert('Нужно е да сте влезли.'); return; }
      try{
        await sendJSON('POST','/news',{
          title:nTitle.value.trim(),
          date:nDate.value.trim(),
          body:nBody.value.trim()
        });
        alert('Новината е публикувана.');
        nTitle.value=''; nDate.value=''; nBody.value='';
        await reloadLists();
      }catch(e){ alert('Грешка: '+e.message); }
    });

    publishEvent.addEventListener('click', async ()=>{
      if(!getKey()){ alert('Нужно е да сте влезли.'); return; }
      try{
        await sendJSON('POST','/events',{
          title:eTitle.value.trim(),
          date:eDate.value.trim(),
          location:eLocation.value.trim()
        });
        alert('Събитието е публикувано.');
        eTitle.value=''; eDate.value=''; eLocation.value='';
        await reloadLists();
      }catch(e){ alert('Грешка: '+e.message); }
    });

    // Старт
    keyInput.value = getKey();
    reflectLogin();
    reloadLists();
  </script>
</body>
</html>
